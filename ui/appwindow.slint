import { Button, StandardButton, VerticalBox, ScrollView, ListView, StandardListView } from "std-widgets.slint";

export component FlatFileTree {
    in property <[string]> files;
}

export struct pos {
    x: int,
    y: int,
}

export struct keybinds {
     up: string,
     down: string,
     into: string,
     outof: string,
     find: string,
     quit: string,
     esc: string,
}


export component AppWindow inherits Window {
    in-out property <[StandardListViewItem]> files;
    in-out property <[StandardListViewItem]> child_files_standard;

    in-out property <pos> position;

    in-out property <int> child_pos: child.current-item;

    in-out property <string> content_of_file;
    in-out property <string> last_path;
    in-out property <string> find_value: find-box.text;
    in-out property <string> new_file_name;
    in-out property <string> delete_file_name;

    in-out property <bool> child_focus: child.has-focus;
    in-out property <bool> find-box-focus: find-box.has-focus;
    in-out property <bool> new_file_visible: false;
    in-out property <bool> new_file_focus: new-file.has-focus;

    in-out property <bool> delete_file_visible: false;
    //in-out property <bool> delete_file_focus: delete-file.has-focus;

    in property <keybinds> keybind;

    callback key_presed(KeyEvent);
    callback create(string);
    callback delete(string);
    callback find();
    callback refresh();
    callback clear_filter();

    public function mainfocus(val: bool) {
        if (val) {
            child.focus();
        } else {
            child.clear-focus();
        }
    }

    public function newfilefocus(val: bool) {
        if (val) {
            new-file.focus();
        } else {
            new-file.clear-focus();
        }
    }

    // public function deletefilefocus(val: bool){
    //     if(val){
    //         delete-file.focus();
    //     }else{
    //         delete-file.clear-focus();
    //     }
    // }

    public function findboxfocus(val: bool) {
        if (val) {
            find-box.focus();
        } else {
            find-box.clear-focus();
        }
    }

    width: 1000px;
    height: 500px;

    background: #2E3440;

    GridLayout {
        Row {
            Rectangle {
                border-width: 1px;
                height: 20px;
                FocusScope {
                    find-box := TextInput {
                        text: "";
                        edited => {
                            find()
                        }
                        accepted => {
                            child.focus();
                            self.clear-focus();
                        }
                    }
                }
            }
        }

        Row {

            HorizontalLayout {
                Rectangle {
                    border-width: 1px;
                    width: root.width / 3;
                    parentlist := StandardListView {
                        enabled: false;
                        model: files;
                    }
                }

                Rectangle {
                    border-color: child.has-focus ? red : green;
                    border-width: 1px;
                    width: root.width / 3;
                    child := StandardListView {
                        width: parent.width;
                        current-item: position.y;
                        model: child_files_standard;
                        forward-focus: global-focus;
                        global-focus := FocusScope {
                            key-pressed(event) => {
                                if (event.text == "f") {
                                    find-box.focus();
                                    reject
                                } else if (event.text == "\u{19}" || event.text == "\u{10}" || event.text == Key.Tab) {
                                    reject
                                } else if (event.text == "q") {
                                    find-box.text = "";
                                    find();
                                    reject
                                } else {
                                    key_presed(event);
                                    accept
                                }
                            }
                        }
                    }
                }
            }
        }

        HorizontalLayout {
            alignment: space-around;
            width: root.width;

            Text {
                text: last_path;
            }

            Text {
                text: "↑: " + keybind.up;
            }

            Text {
                text: " ↓: " + keybind.down;
            }

            Text {
                text: " ←: " + keybind.outof;
            }

            Text {
                text: " →: " + keybind.into;
            }

            Text {
                text: "Filter: " + keybind.find;
            }

            Text {
                text: "Reset Filter: " + keybind.quit;
            }
        }
    }

    GridLayout {
        width: root.width;
        height: root.height;
        Row {
            FocusScope {
                VerticalLayout {
                    alignment: center;
                    HorizontalLayout {
                        alignment: center;
                        Text {
                            visible: new_file_visible;
                            text: "New File Name: ";
                        }

                        new-file := TextInput {
                            visible: new_file_visible;

                            text: new_file_name;
                            accepted => {
                                create(self.text);
                                self.clear-focus();
                                mainfocus(true);
                                new_file_visible = false;
                                refresh();
                            }
                        }
                    }
                }
            }
        }
    }

    delete-file := Dialog {
        visible: delete_file_visible;
        width: root.width;
        VerticalLayout {
            Text {
                text: "Are you sure you want to delete: " + delete_file_name;
            }

            StandardButton {
                width: delete-file.width / 10;
                kind: yes;
                clicked => {
                    delete(delete_file_name);
                    delete_file_visible = false;
                    refresh();
                }
            }

            StandardButton {
                width: delete-file.width / 10;
                kind: no;
                clicked => {
                    delete_file_visible = false;
                }
            }
        }
    }
}
